# Get The Name Of The Branch Contained In The Current Folder
function git-branch-parse {
  git branch 2> /dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/[\1]/'
}

# Create A Local Branch And Push It To The Remote Repository
# $1 = Branch Name
function git-create-branch {
  if [[ ! -z ${1} ]]; then
    git checkout -b \"${1}\"
    git push --set-upstream origin \"${1}\"
  fi
}

# Commit All Changed Files To Git
# $1 = Commit Message
function git-commit {
  if [[ ! -z ${1} ]]; then
    git add .
    git commit -S -m "${1}"
  else
    echo "[ERROR] No Commit Message Specified."
  fi
}

# Delete A Branch Locally And Remotely
# $1 = Branch Name
function git-delete-branch {
  if [[ ! -z ${1} ]]; then
    branch_in_local=`git branch | grep -i "${1}"`
    if [[ ! -z ${branch_in_local} ]]; then
      git branch -d \"${branch_in_local}\"
      git push -d origin \"${branch_in_local}\"
    fi
  fi
}

# Create A Commit And Push It To The Remote Repository
# $1 = Commit Message
function git-push {
  if [[ ! -z ${1} ]]; then
    git add .
    git commit -S -m "${1}"
    git push --set-upstream origin $(git branch --show-current)
  else
    echo "[ERROR] No Commit Message Specified."
  fi
}

# Show List Of Local Git Branches
function git-show-local {
  local start_dir=$(pwd)
  local git_project_dirs=($(find ${BNC_REPOS_DIR}/* -maxdepth 0))

  for project_dir in ${git_project_dirs[@]}; do
    echo "Project: $(basename ${project_dir})"
    git_repo_dirs=($(find ${project_dir}/* -maxdepth 0 -type d))

    for repo_dir in ${git_repo_dirs}; do
      echo ""
      echo "  Repo: $(basename ${repo_dir})"
      local_branches=$(grep -E '^\[branch.*\]$' ${repo_dir}/.git/config | sed -e 's/^\[branch \"//g' | sed -e 's/\"\]//g')
      for branch_name in ${local_branches[@]}; do
        echo "    Branch: ${branch_name}"
      done
    done
    echo ""
  done

  cd ${start_dir}
}

# Switch Branch And Pull From Remote To Update It
# $1 = Branch Name
function git-switch {
  branch_name=${1}

  if [[ ! -z ${branch_name} ]]; then
    git branch | grep -i ${branch_name} > /dev/null 2>&1

    if [[ ${?} -eq 0 ]]; then
      git switch ${branch_name} > /dev/null 2>@1 | grep -i "behind" > /dev/null 2>&1

      echo "Switched Branch To '${branchName}'."

      if [[ ${?} -eq 0 ]]; then
        echo "Local Branch ${branch_name} Is Up To Date With Remote."
      else
        echo "Local Branch '${branch_name}' Is Behind Remote. Pulling Changes From Remote."
        git pull > /dev/null 2>&1

        if [[ ${?} -eq 0 ]]; then
          echo "Pull Successful."
        else
          echo "Pull Failed."
        fi
      fi
    else
      echo "Branch ${branch_name} Does Not Exist Locally."
    fi
  else
    echo "No Branch Name Specified to git-switch."
  fi
}

# Update Branches In Git Repos
# $1 = all | project
function git-update-branches {
  _print-header "Updating Local Git Branches"

  if [[ ! (${1} == "project" || ${1} == "all") ]]; then
    echo "SYNTAX: git-update-branch [all|project]"
    return 1
  fi

  local start_dir=$(pwd)
  local logs_dir=${HOME}/.git-update
  
  for git_repo_dir in ${GIT_REPO_DIRS[@]}; do
    local git_project_dirs=($(find ${git_repo_dir}/* -maxdepth 0))
    
    mkdir -p ${logs_dir}

    if [[ ${1} == "project" ]]; then
      local project_index=1

      echo "Project List:"
      echo ""

      for project_name in ${git_project_dirs[@]}; do
        echo "   ${project_index}: $(basename ${project_name})"
        (( project_index++ ))
      done
      
      echo ""
      echo -n "Enter A Project Index [1 - $(( ${project_index} - 1 ))]: "
      read selected_project_index

      if [[ ${selected_project_index} -lt 1 || ${selected_project_index} -gt $(( ${project_index} -1 )) ]]; then
        echo "[ERROR] Invalid Project Index Selected"
        return 1
      else
        local git_project_dirs=(${git_project_dirs[${selected_project_index}]})
      fi
    fi

    for project_dir in ${git_project_dirs[@]}; do
      mkdir -p ${logs_dir}/$(basename ${project_dir})

      echo "${COLOR_YELLOW}Project: ${COLOR_WHITE}$(basename ${project_dir})"
      
      if [[ $(ls -A ${project_dir}) ]]; then
        git_repo_dirs=($(find ${project_dir}/* -maxdepth 0 -type d))
      else
        git_repo_dirs=()
      fi

      for repo_dir in ${git_repo_dirs[@]}; do
        local log_file=${logs_dir}/$(basename ${project_dir})/$(basename ${repo_dir}).log
        
        if [[ -z $(ls -A ${repo_dir}) ]]; then
          continue
        fi
        
        echo "" 
        echo "   ${COLOR_YELLOW}Repo: ${COLOR_WHITE}$(basename ${repo_dir})"
        local_branches=($(grep -E '^\[branch.*\]$' ${repo_dir}/.git/config | sed 's/^\[branch \"//g' | sed 's/\"\]//g'))
        
        for local_branch in ${local_branches[@]}; do
          echo "      ${COLOR_YELLOW}Branch${COLOR_WHITE}: ${local_branch}"

          cd ${repo_dir}
          git switch ${local_branch} &> /dev/null
          git pull &>> ${log_file}

          echo -n "      ${COLOR_YELLOW}Status${COLOR_WHITE}: "
          
          if [[ $? -eq 0 ]]; then
            echo "${COLOR_GREEN}Success${COLOR_WHITE}"
          else
            echo "${COLOR_RED}Failure${COLOR_WHITE}"
            echo "      ${COLOR_YELLOW}Log   ${COLOR_WHITE}: ~/.git_update/$(basename ${project_dir})/$(basename ${repo_dir}).log"
          fi
        done
      done
      echo ""
    done
  done

  cd ${start_dir}
}
